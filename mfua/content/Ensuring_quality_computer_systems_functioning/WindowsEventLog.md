> ## Система логирования в современных версиях Windows (8/10/11, Server 2012 R2 и новее) — это мощная и комплексная экосистема, кардинально отличающаяся от простых текстовых файлов.

### 1. Фундамент: Журналы событий Windows (Windows Event Log)

Это основная и самая известная подсистема логирования. Её ключевые компоненты:

#### **Архитектура и ключевые понятия**

*   **Служба журнала событий (Event Log service):** Управляет всей системой.
*   **Журналы (Logs):** Логи группируются по жёстким и программным категориям.
*   **Источники событий (Event Sources):** Приложение или компонент системы, который генерирует событие (например, "Winlogon" или "MyApplication").
*   **Поставщики событий (Event Providers):** Программные компоненты, которые регистрируются в системе для записи событий.
*   **Каналы событий (Event Channels):** Новый термин, введённый для более гибкого управления логированием.

#### **Основные журналы (Windows Logs)**

Это стандартный набор, знакомый большинству администраторов. Доступен в оснастке `eventvwr.msc`.

*   **Application (Приложения):** События от приложений и программ.
*   **System (Система):** События от компонентов операционной системы (драйверы, службы).
*   **Security (Безопасность):** События аудита (входы в систему, доступ к ресурсам). Это самый критически важный журнал для безопасности.
*   **Setup (Установка):** События, связанные с установкой и обновлением ОС.
*   **Forwarded Events (Перенаправленные события):** События, собранные с других компьютеров.

#### **Журналы приложений и служб (Applications and Services Logs)**

Более современная и структурированная система логирования, появившаяся в Vista/Server 2008. Здесь хранятся логи от отдельных компонентов ОС и приложений.

*   **Группировка:**
    *   **Microsoft / Windows:** Логи от компонентов самой Windows (например, `Windows Defender`, `Firewall`, `PowerShell`).
    *   **HardwareEvents:** События, связанные с оборудованием.
    *   **Internet Explorer:** Логи браузера.
*   **Типы журналов внутри этой категории:**
    *   **Admin (Административные):** События, понятные администратору, с предлагаемыми решениями.
    *   **Operational (Операционные):** Детальные события о работе компонента. Включены по умолчанию.
    *   **Analytic (Аналитические):** Очень детальные логи для глубокой диагностики. Отключены по умолчанию.
    *   **Debug (Отладочные):** Наиболее подробные логи для разработчиков. Отключены по умолчанию.

---

### 2. Формат и структура событий: EVTX и XML

Современные журналы хранятся в бинарных файлах с расширением **.evtx** в папке `%SystemRoot%\System32\winevt\Logs\`.

*   **Каждое событие имеет строгую структуру:**
    *   **Уровень события (Level):** Information (Сведения), Warning (Предупреждение), Error (Ошибка), Critical (Критическое), Verbose (Подробное).
    *   **Дата и время.**
    *   **Код события (Event ID):** Уникальный номер, идентифицирующий тип события.
    *   **Источник (Source):** Компонент, сгенерировавший событие.
    *   **Категория задачи.**
    *   **Ключевые слова (Keywords):** Метки для фильтрации (например, "Audit Success").
    *   **Пользователь и компьютер.**
    *   **Данные события (Event Data):** Самая важная часть, представленная в виде структурированных XML-данных. Это делает информацию машиночитаемой и удобной для парсинга.

**Пример данных события в XML:**
```xml
<EventData>
  <Data Name="SubjectUserSid">S-1-5-21-3623811015-3361044348-30300820-1013</Data>
  <Data Name="SubjectUserName">d.smith</Data>
  <Data Name="SubjectDomainName">CONTOSO</Data>
  <Data Name="IpAddress">192.168.1.15</Data>
  <Data Name="LogonType">3</Data>
</EventData>
```

---

### 3. Управление и анализ логов

#### **Графические утилиты**

1.  **Просмотр событий (Event Viewer, `eventvwr.msc`):**
    *   Стандартная оснастка для ручного просмотра и базового управления.
    *   Позволяет создавать **Пользовательские представления** — сохранённые фильтры для быстрого доступа к нужным событиям.

2.  **Монитор надежности (Reliability Monitor, `perfmon /rel`):**
    *   Визуализирует стабильность системы, показывая сбои приложений, предупреждения и установку ПО на временной шкале.

#### **Командная строка и PowerShell**

Мощь современного логирования раскрывается именно здесь.

1.  **Wevtutil.exe:** Швейцарский нож для управления журналами.
    ```powershell
    # Экспорт журнала
    wevtutil epl System C:\backup\system-log.evtx

    # Получение информации о журнале
    wevtutil gl System

    # Очистка журнала
    wevtutil cl Application
    ```

2.  **PowerShell (Get-WinEvent):** Самый мощный и гибкий инструмент.
    ```powershell
    # Получить последние 10 ошибок из системного журнала
    Get-WinEvent -LogName System -MaxEvents 10 -ErrorAction SilentlyContinue | Where-Object {$_.Level -eq 2}

    # Получить события по коду (например, ID 4624 - успешный вход)
    Get-WinEvent -FilterHashtable @{LogName='Security'; ID=4624} -MaxEvents 5

    # Фильтрация по XML-запросу (самый гибкий метод)
    $xmlQuery = "<QueryList><Query Id='0' Path='Security'><Select Path='Security'>*[System[(EventID=4624)]]</Select></Query></QueryList>"
    Get-WinEvent -FilterXPath $xmlQuery

    # Поиск в данных события (например, имя пользователя)
    Get-WinEvent -LogName Security | Where-Object {$_.Message -like "*d.smith*"}
    ```

---

### 4. Подсистема ETW (Event Tracing for Windows)

**ETW** — это низкоуровневый, высокопроизводительный механизм трассировки, который лежит в основе всего современного логирования Windows.

*   **Принцип работы:**
    *   **Поставщики (Providers):** Компоненты ядра и приложения регистрируют себя как поставщики ETW.
    *   **Сессии (Sessions):** Администратор или приложение запускает сессию трассировки и подписывается на определённых поставщиков.
    *   **Поток событий:** События в реальном времени записываются в бинарные файлы (.etl).
*   **Для чего используется:**
    *   Глубокий анализ производительности.
    *   Отладка сложных проблем.
    *   Трассировка сетевой активности.
*   **Инструменты для работы с ETW:**
    *   **Performance Monitor (perfmon):** Для сбора базовых счётчиков.
    *   **Windows Performance Recorder (WPR) / Windows Performance Analyzer (WPA):** Мощные инструменты для записи и детального анализа трассировок ETW.
    *   **Командная строка:** `logman`, `tracelog`, `xperf`.

---

### 5. Централизованный сбор логов и SIEM

В корпоративной среде логи с рабочих станций и серверов пересылаются на центральный сервер для анализа и безопасного хранения.

*   **Подписки на события (Event Subscriptions):**
    *   Настраиваются через "Просмотр событий" или групповые политики.
    *   Позволяют одному компьютеру (коллектору) подписываться на события с других компьютеров источника.
*   **Инструменты SIEM (Security Information and Event Management):**
    *   **Microsoft Sentinel:** Нативное облачное SIEM-решение от Microsoft.
    *   **Splunk, QRadar, ArcSight:** Популярные сторонние решения.
    *   Для сбора данных эти системы используют **агентов** или стандартные протоколы (например, **Windows Event Forwarding**).

#### **Настройка пересылки событий (Windows Event Forwarding)**

1.  На компьютере-источнике настраивается политика **Windows Remote Management (WinRM)**.
2.  На компьютере-коллекторе создаётся **Подписка**.
3.  Указываются компьютеры-источники и события, которые нужно пересылать.

---

### 6. Логи файловой системы и приложений

Помимо журналов событий, в Windows существуют и другие важные источники логов:

*   **Файлы журналов IIS:** Хранятся по умолчанию в `%SystemDrive%\inetpub\logs\LogFiles\`. Имеют структурированный текстовый формат (W3C Extended Log Format).
*   **Логи PowerShell:** Могут быть включены через **Политику аудита модуля PowerShell**. События записываются в журнал `Microsoft-Windows-PowerShell/Operational`.
*   **Логи Sysmon (System Monitor):** Бесплатная утилита от Microsoft Sysinternals, которая значительно расширяет детализацию системных событий (создание процессов, сетевые подключения, изменения в реестре), записывая их в отдельный журнал.

### Резюме для специалиста по качеству КС

Понимание системы логирования Windows критически важно, потому что:

*   **Это основной источник диагностики:** Подавляющее большинство сбоев ОС, драйверов и приложений фиксируется в журналах событий.
*   **Объект безопасности и аудита:** Журнал "Безопасность" и логи PowerShell являются ключевыми для расследования инцидентов и соответствия требованиям (комплаенс).
*   **Структурированные данные:** Формат на основе XML позволяет автоматизировать парсинг и анализ с помощью PowerShell и SIEM-систем.
*   **Масштабируемость:** Возможности централизованного сбора (Event Forwarding, SIEM) делают систему пригодной для мониторинга качества функционирования крупных распределённых компьютерных систем.